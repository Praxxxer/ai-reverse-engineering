<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverse Engineering AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f1116;
            color: #e5e7eb;
        }
        .panel {
            background-color: #1a1d23;
            border-radius: 0.5rem;
        }
        .chat-bubble-user {
            background-color: #374151;
        }
        .chat-bubble-assistant {
            background-color: #2d333b;
        }
        .sidebar {
            background-color: #1a1d23;
        }
        input::placeholder, textarea::placeholder {
            color: #9ca3af;
        }
    </style>
</head>
<body class="flex h-screen">

    <div class="w-1/4 sidebar flex flex-col p-5 border-r border-gray-700">
        <h1 class="text-xl font-semibold mb-6 text-white">Reverse Engineering AI Assistant</h1>
        <form id="upload-form" class="mb-6">
            <label for="file-input" class="block mb-2 text-sm font-medium text-gray-300">Upload Binary for Analysis</label>
            <input type="file" id="file-input" class="block w-full text-sm text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer"/>
            <button type="submit" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition">Analyze</button>
        </form>
        <div id="upload-status" class="text-sm text-center mb-4 h-5"></div>
        <h2 class="text-md font-semibold border-t border-gray-700 pt-4 text-gray-300">Analysis Jobs</h2>
        <div id="jobs-list" class="flex-grow overflow-y-auto mt-3 space-y-3"></div>
    </div>

    <div class="w-3/4 flex flex-col h-screen">
        <div id="welcome-message" class="flex-grow flex items-center justify-center">
            <div class="text-center text-gray-500">
                <h2 class="text-2xl font-semibold text-gray-300">Welcome</h2>
                <p class="mt-2 text-sm">Upload a file and select a job to begin your analysis.</p>
            </div>
        </div>
        <div id="chat-container" class="hidden flex-grow flex flex-col p-6 overflow-hidden">
            <div id="chat-log" class="flex-grow overflow-y-auto mb-4 p-4 panel"></div>
            <form id="chat-form" class="flex items-end">
                <textarea id="chat-input" class="flex-grow bg-gray-800 rounded-l-md p-3 focus:outline-none resize-none text-gray-200" placeholder="Enter command..." rows="1" disabled></textarea>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-5 rounded-r-md transition self-stretch">Send</button>
            </form>
        </div>
    </div>

<script>
$(document).ready(function() {
    let currentJobId = null;
    let jobStatusPollers = {};
    function showUploadStatus(message, isError = false) {
        $('#upload-status').text(message).toggleClass('text-red-400', isError).toggleClass('text-green-400', !isError);
    }
    function addChatMessage(role, message) {
        const senderClass = role === 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant';
        const sanitizedMessage = $('<div/>').text(message).html();
        $('#chat-log').append(`
            <div class="mb-4">
                <div class="p-3 rounded-md ${senderClass}">${sanitizedMessage}</div>
            </div>
        `);
        $('#chat-log').scrollTop($('#chat-log')[0].scrollHeight);
    }
    function addShimmerPlaceholder() {
        const placeholderId = `shimmer-${Date.now()}`;
        $('#chat-log').append(`
            <div id="${placeholderId}" class="mb-4">
                <div class="p-3 rounded-md chat-bubble-assistant space-y-3">
                    <div class="h-4 w-5/6 rounded bg-gray-700 animate-pulse"></div>
                    <div class="h-4 w-full rounded bg-gray-700 animate-pulse"></div>
                    <div class="h-4 w-3/4 rounded bg-gray-700 animate-pulse"></div>
                </div>
            </div>
        `);
        $('#chat-log').scrollTop($('#chat-log')[0].scrollHeight);
        return placeholderId;
    }
    function pollStatus(jobId) {
        if (jobStatusPollers[jobId]) return;
        jobStatusPollers[jobId] = setInterval(async () => {
            try {
                const response = await fetch(`/status/${jobId}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const status = data.status || 'unknown';
                const $jobItem = $(`#job-${jobId} .job-status`);
                $jobItem.text(status.toUpperCase());
                if (status === 'done') {
                    $jobItem.removeClass('text-yellow-400').addClass('text-green-400');
                    clearInterval(jobStatusPollers[jobId]);
                    delete jobStatusPollers[jobId];
                } else if (status === 'failed') {
                    $jobItem.removeClass('text-yellow-400').addClass('text-red-400');
                    clearInterval(jobStatusPollers[jobId]);
                    delete jobStatusPollers[jobId];
                }
            } catch (error) {
                console.error("Polling error:", error);
                const $jobItem = $(`#job-${jobId} .job-status`);
                $jobItem.text('ERROR').addClass('text-red-400');
                clearInterval(jobStatusPollers[jobId]);
                delete jobStatusPollers[jobId];
            }
        }, 3000);
    }
    $('#upload-form').on('submit', function(e) {
        e.preventDefault();
        const fileInput = $('#file-input')[0];
        if (fileInput.files.length === 0) {
            showUploadStatus('ERROR: No file selected.', true);
            return;
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        showUploadStatus('Analyzing...', false);
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                if (data.error) {
                    showUploadStatus(`ERROR: ${data.error}`, true);
                    return;
                }
                showUploadStatus('Analysis started!', false);
                const { job_id, status } = data;
                const filename = fileInput.files[0].name;
                const newJobHtml = `
                    <div id="job-${job_id}" class="job-item p-3 bg-gray-800 hover:bg-gray-700 rounded-md cursor-pointer transition" data-job-id="${job_id}">
                        <div class="font-medium truncate text-gray-200">${filename}</div>
                        <div class="text-xs text-gray-400">ID: ${job_id.substring(0,8)}...</div>
                        <div class="text-xs text-yellow-400 font-mono job-status mt-1">${status.toUpperCase()}</div>
                    </div>`;
                $('#jobs-list').prepend(newJobHtml);
                pollStatus(job_id);
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error.';
                showUploadStatus(`UPLOAD FAILED: ${error}`, true);
            }
        });
    });
    $('#jobs-list').on('click', '.job-item', function() {
        currentJobId = $(this).data('job-id');
        $('.job-item').removeClass('bg-gray-700');
        $(this).addClass('bg-gray-700');
        $('#welcome-message').hide();
        $('#chat-container').removeClass('hidden').addClass('flex');
        $('#chat-input, #chat-form button').prop('disabled', false);
        $('#chat-log').html('');
        addChatMessage('assistant', `Connected to job ${currentJobId}. Awaiting command...`);
        $('#chat-input').focus();
    });
    $('#chat-input').on('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            $('#chat-form').submit();
        }
    }).on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    $('#chat-form').on('submit', function(e) {
        e.preventDefault();
        const $chatInput = $('#chat-input');
        const message = $chatInput.val().trim();
        if (!message || !currentJobId) return;
        addChatMessage('user', message);
        $chatInput.val('').trigger('input');
        $('#chat-input, #chat-form button').prop('disabled', true);
        const placeholderId = addShimmerPlaceholder();
        const $placeholder = $(`#${placeholderId}`);
        const $responseContainer = $placeholder.find('.p-3');
        
        let fullResponse = "";
        let toolCallsHtml = "";
        fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: message, job_id: currentJobId })
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            $responseContainer.html('<div class="markdown-content"></div><div class="tool-calls"></div>');
            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        $('#chat-input, #chat-form button').prop('disabled', false);
                        $('#chat-input').focus();
                        return;
                    }
                    const chunk = decoder.decode(value, {stream: true});
                    const lines = chunk.split('\n\n').filter(line => line.trim());
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                if (data.type === 'token') {
                                    fullResponse += data.content;
                                    $responseContainer.find('.markdown-content').html(marked.parse(fullResponse));
                                } else if (data.type === 'tool_call') {
                                    toolCallsHtml += `<li>${data.description}</li>`;
                                    $responseContainer.find('.tool-calls').html(`<div class="text-xs text-gray-400 mt-2 bg-gray-900 p-2 rounded border border-gray-700"><strong>SYSTEM LOG:</strong><ul>${toolCallsHtml}</ul></div>`);
                                } else if (data.type === 'error') {
                                    $responseContainer.html(`<div class="text-red-400">ERROR: ${data.content}</div>`);
                                }
                            } catch (e) {
                                console.error("Error parsing stream data:", e, "Data:", line);
                            }
                        }
                    });
                    $('#chat-log').scrollTop($('#chat-log')[0].scrollHeight);
                    read();
                });
            }
            read();
        }).catch(err => {
            console.error("Fetch stream error:", err);
            $responseContainer.html(`<div class="text-red-400">FATAL ERROR: Connection to assistant failed.</div>`);
            $('#chat-input, #chat-form button').prop('disabled', false);
        });
    });
});
</script>

</body>
</html>
